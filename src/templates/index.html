{% extends "layout.html" %}

{% block title %}
  References Management App
{% endblock %}

{% block body %}

  <h2 class="text-center my-4 text-success">References Management App</h2>
  <input type="text" id="search-bar" onkeyup="search()" placeholder="Search for references..">

  <script>
    function search() {
      // Declare variables
      var input, filter, table, tr, td, i, txtValue, show_row;
      input = document.getElementById("search-bar");
      filter = input.value.toUpperCase();
      table = document.querySelector("#table-div #table #table-body");
      tr = table.getElementsByTagName("tr");
      // Loop through all table rows
      for (i = 0; i < tr.length; i++) {
        show_row = false;
        // For every row, loop through every cell
        for (j = 0; j < 4; j++) {
          td = tr[i].getElementsByTagName("td")[j];
          if (td) {
            txtValue = td.textContent || td.innerText;
            // If the contents of at least one cell matches, the row will be shown
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              show_row = true;
            }
          }
        }
        if (show_row) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }
  </script>

  <div class="table-container mb-4" id="table-div">
    <table class="table table-striped table-boarded" id="table">
      <thead>
        <tr>
          <th>Type</th>
          <th>Reference ID</th>
          <th>Author</th>
          <th>Title</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody id="table-body">
        {% for reference in references %}
          <tr>
            <td>{{ reference.reference_type }}</td>
            <td>{{ reference.reference_id }}</td>
            <td>{{ reference.author }}</td>
            <td>{{ reference.title }}</td>
            <td>
              <div
              class="details"
              id="details_{{ reference.id }}"
              style="display:none;"
              >
                {% if reference.year %}Year: {{ reference.year }}<br />{% endif %}
                {% if reference.booktitle %}Booktitle: {{ reference.booktitle }}<br />{% endif %}
                {% if reference.editor %}Editor: {{ reference.editor }}<br />{% endif %}
                {% if reference.volume %}Volume: {{ reference.volume }}<br />{% endif %}
                {% if reference.number %}Number: {{ reference.number }}<br />{% endif %}
                {% if reference.series %}Series: {{ reference.series }}<br />{% endif %}
                {% if reference.pages %}Pages: {{ reference.pages }}<br />{% endif %}
                {% if reference.address %}Address: {{ reference.address }}<br />{% endif %}
                {% if reference.journal %}Journal: {{ reference.journal }}<br />{% endif %}
                {% if reference.month %}Month: {{ reference.month }}<br />{% endif %}
                {% if reference.note %}Note: {{ reference.note }}<br />{% endif %}
                {% if reference.organization %}Organization: {{ reference.organization }}<br />{% endif %}
                {% if reference.publisher %}Publisher: {{ reference.publisher }}<br />{% endif %}
              </div>
              <button
                type="button"
                class="toggle-btn"
                name="show_more_button"
                data-ref-id="{{ reference.id }}"
              >
                Show more
              </button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    // Function to toggle the visibility of the details section for each reference
    document.querySelectorAll(".toggle-btn").forEach((button) => {
      button.addEventListener("click", () => {
        const refId = button.getAttribute("data-ref-id");
        const detailsSection = document.getElementById(`details_${refId}`);
        const isVisible = detailsSection.style.display === "block";

        // Toggle the visibility: show if hidden, hide if visible
        detailsSection.style.display = isVisible ? "none" : "block";
        // Change the button text based on visibility
        button.textContent = isVisible ? "Show more" : "Hide";
      });
    });
  </script>
  <div class="container-fluid mb-4">
    <a href="/new_reference" class="btn btn-success" id="button_to_reference">
      Create a new reference</a
    >
    <form action="/download" method="GET" style="display: block;">
      <br />
      <button type="submit" name="download"  class="btn btn-success">Download</button>
    </form>
    <br />
    <a href="/preview" class="btn btn-success" id="button_to_preview">Preview</a>
  </div>
  {% with messages = get_flashed_messages() %}{% if messages %}
    <ul>
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}{% endwith %}
{% endblock %}
